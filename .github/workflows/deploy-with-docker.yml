name: CI/CD with Docker Compose, SHA Tags & Rollback

on:
  push:
    branches: [ main ]

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          no-cache: true
          push: true
          platforms: linux/amd64
          tags: |
            ${{secrets.DOCKER_USERNAME}}/temp-backend:${{github.SHA}}
            ${{secrets.DOCKER_USERNAME}}/temp-backend:latest

  deploy:
    needs: build-test
    runs-on: ubuntu-latest

    steps:
      - name: Deploy on EC2 with Docker Pull
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.backend_EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.backend_aws_ssh_key }}
          script: |
            export IMAGE=${{ secrets.DOCKER_USERNAME }}/temp-backend:${{ github.sha }}
            export CONTAINER=temp-backend
            export DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
            export DOCKER_PASSWORD=${{ secrets.DOCKER_PASSWORD }}

            docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD

            echo "Pull latest image from Docker Hub"
            docker pull $IMAGE

            echo "Tagging current container image as rollback (if exists)"
            if docker inspect $CONTAINER &> /dev/null; then
              CURRENT_IMAGE=$(docker inspect --format='{{.Config.Image}}' $CONTAINER)
              docker tag $CURRENT_IMAGE ${{ secrets.DOCKER_USERNAME }}/temp-backend:rollback
              echo "Rollback tag created from current image: $CURRENT_IMAGE"
            fi

            echo "Clean up old container"
            docker stop temp-backend || true
            docker rm temp-backend || true

            echo "Run Docker container with PM2"
            docker run -d \
              --name temp-backend \
              -p 9000:8000 \
              --restart unless-stopped \
              $IMAGE
            
            echo "Deployment successful"
        
  rollback:
    if: failure()
    needs: deploy
    runs-on: ubuntu-latest

    steps:
      - name: Rollback on EC2 if Deploy Fails
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.temp-backend-ssh }}
          script: |
            echo "Deployment failed. Rolling back..."

            docker stop temp-backend || true
            docker rm temp-backend || true

            docker run -d \
              --name temp-backend \
              -p 9000:8000 \
              --restart unless-stopped \
              ${{ secrets.DOCKER_USERNAME }}/temp-backend:rollback

            echo "Rollback complete."
